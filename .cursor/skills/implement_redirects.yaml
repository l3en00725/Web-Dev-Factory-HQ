description: Create redirects between legacy and new URLs and output a Vercel-compatible manifest.
inputs:
  - name: astro_project_path
    type: path
    required: true
    description: Astro project where redirect manifest will reside.
  - name: old_urls
    type: path
    required: true
    description: CSV of legacy URLs.
  - name: new_urls
    type: path
    required: true
    description: CSV of newly generated URLs.
outputs:
  - name: redirect_manifest
    type: path
    description: Vercel redirect configuration file.
  - name: redirect_report
    type: path
    description: JSON audit of redirect coverage.
environment:
  node: "20.x"
  package_manager: bun
steps:
  - id: install_redirect_tooling
    name: Install redirect tooling
    run: |
      set -euo pipefail
      cd "{{ inputs.astro_project_path }}"
      bun add -D csv-parse@latest csv-stringify@latest yargs@latest node-fetch@latest
      mkdir -p scripts reports/migration
      if [ ! -f scripts/generate-redirects.mjs ]; then
        cat <<'GEN' > scripts/generate-redirects.mjs
        import fs from "node:fs"
        import path from "node:path"
        import { parse } from "csv-parse/sync"
        import { stringify } from "csv-stringify/sync"
        import yargs from "yargs"
        import { hideBin } from "yargs/helpers"
        const argv = yargs(hideBin(process.argv))
          .option("legacy", { type: "string", demandOption: true })
          .option("inventory", { type: "string", demandOption: true })
          .option("out", { type: "string", demandOption: true })
          .parse()
        const legacyRows = parse(fs.readFileSync(argv.legacy), { columns: true })
        const newRows = parse(fs.readFileSync(argv.inventory), { columns: true })
        const redirects = []
        const unmatched = []
        const map = new Map(newRows.map((row) => [row.slug ?? row.url ?? row.path, row.url ?? row.path]))
        for (const row of legacyRows) {
          const key = row.slug ?? row.url ?? row.path
          const target = map.get(key)
          if (target) {
            redirects.push({ source: row.url ?? row.path, destination: target, permanent: true })
          } else {
            unmatched.push(row)
          }
        }
        const manifest = { redirects }
        fs.writeFileSync(path.resolve(argv.out), JSON.stringify(manifest, null, 2))
        fs.writeFileSync(path.resolve("reports/migration/redirect_unmatched.csv"), stringify(unmatched, { header: true }))
        GEN
      fi
      if [ ! -f scripts/verify-redirects.mjs ]; then
        cat <<'VER' > scripts/verify-redirects.mjs
        import fs from "node:fs"
        import path from "node:path"
        import fetch from "node-fetch"
        import yargs from "yargs"
        import { hideBin } from "yargs/helpers"
        const argv = yargs(hideBin(process.argv))
          .option("manifest", { type: "string", demandOption: true })
          .option("domain", { type: "string", demandOption: false })
          .option("out", { type: "string", demandOption: true })
          .parse()
        const manifest = JSON.parse(fs.readFileSync(argv.manifest, "utf-8"))
        const domain = argv.domain && argv.domain.length ? argv.domain : "http://127.0.0.1:4321"
        const results = []
        for (const redirect of manifest.redirects ?? []) {
          const url = new URL(redirect.source, domain).toString()
          const res = await fetch(url, { redirect: "manual" })
          results.push({
            source: redirect.source,
            status: res.status,
            location: res.headers.get("location")
          })
        }
        fs.writeFileSync(path.resolve(argv.out), JSON.stringify(results, null, 2))
        VER
      fi
    success_criteria:
      - Redirect scripts generated under scripts/
  - id: generate_manifest
    name: Generate Vercel redirect manifest
    run: |
      set -euo pipefail
      cd "{{ inputs.astro_project_path }}"
      bun run scripts/generate-redirects.mjs \
        --legacy "{{ inputs.old_urls }}" \
        --inventory "{{ inputs.new_urls }}" \
        --out vercel.json
      bunx prettier --write vercel.json
    success_criteria:
      - vercel.json includes redirects array
  - id: audit_redirects
    name: Audit redirect coverage
    run: |
      set -euo pipefail
      cd "{{ inputs.astro_project_path }}"
      bun run scripts/verify-redirects.mjs \
        --manifest vercel.json \
        --out reports/migration/redirect_audit.json
      jq 'all(.[]; .status == 301)' reports/migration/redirect_audit.json
    success_criteria:
      - redirect_audit.json exists and shows 301 status codes
outputs_mapping:
  redirect_manifest: "{{ inputs.astro_project_path }}/vercel.json"
  redirect_report: "{{ inputs.astro_project_path }}/reports/migration/redirect_audit.json"
artifacts:
  - path: "{{ inputs.astro_project_path }}/vercel.json"
    description: Redirect manifest for Vercel deployment.
  - path: "{{ inputs.astro_project_path }}/reports/migration/redirect_audit.json"
    description: Redirect validation report.
  - path: "{{ inputs.astro_project_path }}/reports/migration/redirect_unmatched.csv"
    description: Legacy URLs lacking mappings.
