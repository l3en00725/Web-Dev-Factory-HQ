description: Initialize a new Astro project, integrate Tailwind + shadcn/ui, and ingest scraped content.
inputs:
  - name: project_slug
    type: string
    required: true
    description: Folder name under /sites to create the Astro project.
  - name: content_map
    type: path
    required: true
    description: JSON map generated by scrape_existing_site.
  - name: media_assets
    type: path
    required: true
    description: Directory of optimized media assets.
  - name: reference_repo
    type: path
    required: false
    description: Optional reference repo for component inspiration.
  - name: business_type
    type: string
    required: true
    description: Business type used to scaffold schema-ready layouts.
outputs:
  - name: astro_project_path
    type: path
    description: Path to the generated Astro project.
  - name: url_inventory
    type: path
    description: CSV mapping of new Astro routes.
environment:
  node: "20.x"
  package_manager: bun
  astro_version: latest
steps:
  - id: create_project
    name: Scaffold Astro project with Tailwind
    run: |
      set -euo pipefail
      PROJECT="{{ workspace }}/sites/{{ inputs.project_slug }}"
      rm -rf "$PROJECT"
      bunx create-astro@latest "$PROJECT" --template basics --install
      cd "$PROJECT"
      bun add -D tailwindcss@latest autoprefixer@latest postcss@latest @astrojs/tailwind@latest @astrojs/image astro-compress
      bunx astro add tailwind
    success_criteria:
      - astro.config.mjs created with Tailwind integration
  - id: install_shadcn
    name: Install shadcn/ui component library for Astro
    run: |
      set -euo pipefail
      PROJECT="{{ workspace }}/sites/{{ inputs.project_slug }}"
      cd "$PROJECT"
      bun add shadcn-ui@latest class-variance-authority@latest tailwind-merge@latest
      bunx shadcn-ui@latest init --framework astro --yes
      bunx shadcn-ui@latest add button card navigation-menu collapsed
    success_criteria:
      - shadcn/ui components generated under src/components/ui
  - id: configure_astrobuilder
    name: Configure Astro project settings
    run: |
      set -euo pipefail
      PROJECT="{{ workspace }}/sites/{{ inputs.project_slug }}"
      cd "$PROJECT"
      bun run scripts/apply-astro-config.mjs \
        --psi-target 0.95 \
        --image-service sharp \
        --islands true
    success_criteria:
      - astro.config.mjs includes image optimization and island config
  - id: import_content
    name: Import scraped content into Astro routes
    run: |
      set -euo pipefail
      PROJECT="{{ workspace }}/sites/{{ inputs.project_slug }}"
      cd "$PROJECT"
      mkdir -p src/pages src/content media
      bun run scripts/import-content.mjs \
        --content "{{ inputs.content_map }}" \
        --media "{{ inputs.media_assets }}" \
        --out src/pages \
        --business "{{ inputs.business_type }}"
      bun run scripts/generate-route-inventory.mjs \
        --pages src/pages \
        --out reports/url_inventory.csv
    success_criteria:
      - src/pages populated with .astro files reflecting H1/H2 hierarchy
      - reports/url_inventory.csv exists
  - id: integrate_reference_components
    name: Copy reference components if repository provided
    run: |
      set -euo pipefail
      PROJECT="{{ workspace }}/sites/{{ inputs.project_slug }}"
      if [ -n "{{ inputs.reference_repo }}" ] && [ -d "{{ inputs.reference_repo }}" ]; then
        rsync -av --exclude="node_modules" "{{ inputs.reference_repo }}/src/components/" "$PROJECT/src/components/reference/"
      fi
    success_criteria:
      - Optional reference components available under src/components/reference
  - id: quality_checks
    name: Run Astro check and first build
    run: |
      set -euo pipefail
      PROJECT="{{ workspace }}/sites/{{ inputs.project_slug }}"
      cd "$PROJECT"
      bun run astro check
      bun run build
      bun run astro sync
    success_criteria:
      - bun run build completes without errors
outputs_mapping:
  astro_project_path: "{{ workspace }}/sites/{{ inputs.project_slug }}"
  url_inventory: "{{ workspace }}/sites/{{ inputs.project_slug }}/reports/url_inventory.csv"
artifacts:
  - path: "{{ workspace }}/sites/{{ inputs.project_slug }}"
    description: Fully scaffolded Astro project ready for optimization.
  - path: "{{ workspace }}/sites/{{ inputs.project_slug }}/reports/url_inventory.csv"
    description: New site URL inventory.
