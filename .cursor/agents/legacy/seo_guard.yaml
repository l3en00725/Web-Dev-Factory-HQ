name: SEO Guard
description: Preserve rankings and ensure technical SEO integrity throughout the migration.
working_directory: "${astro_project_path}"
output_directory: "output/${site_name}/seo"
inputs:
  - name: astro_project_path
    type: path
    required: true
    description: Astro project root.
  - name: domain_url
    type: string
    required: true
    description: Primary domain being migrated.
  - name: redirect_manifest
    type: path
    required: true
    description: Redirect map generated by Migration Manager.
outputs:
  - name: seo_report
    type: path
    description: Comprehensive SEO verification report.
  - name: sitemap
    type: path
    description: Generated sitemap XML.
  - name: robots
    type: path
    description: Robots.txt file after validation.
tasks:
  - id: audit_meta
    name: Audit titles and meta descriptions
    run: |
      bun run scripts/audit-meta.mjs \
        --project {{ inputs.astro_project_path }} \
        --out reports/seo/meta_audit.json
    cwd: "{{ inputs.astro_project_path }}"
    success_criteria:
      - Every page includes unique title and meta description
  - id: ensure_canonicals
    name: Ensure canonical tags and internal linking
    run: |
      bun run scripts/enforce-canonicals.mjs \
        --project {{ inputs.astro_project_path }} \
        --domain {{ inputs.domain_url }}
      bun run scripts/audit-internal-links.mjs \
        --project {{ inputs.astro_project_path }} \
        --out reports/seo/internal_links.json
    cwd: "{{ inputs.astro_project_path }}"
    success_criteria:
      - Canonical tags reference primary domain
      - No orphan pages detected
  - id: generate_sitemap
    name: Generate sitemap.xml
    run: |
      bun run scripts/generate-sitemap.mjs \
        --project {{ inputs.astro_project_path }} \
        --domain {{ inputs.domain_url }} \
        --out public/sitemap.xml
    cwd: "{{ inputs.astro_project_path }}"
    success_criteria:
      - public/sitemap.xml exists and passes xmllint
  - id: validate_robots
    name: Validate robots.txt
    run: |
      bun run scripts/validate-robots.mjs \
        --domain {{ inputs.domain_url }} \
        --project {{ inputs.astro_project_path }} \
        --out public/robots.txt
    cwd: "{{ inputs.astro_project_path }}"
    success_criteria:
      - robots.txt allows core pages and blocks staging
  - id: compare_url_lists
    name: Compare legacy vs new URL list
    run: |
      bun run scripts/compare-urls.mjs \
        --old {{ inputs.redirect_manifest }} \
        --new reports/url_inventory.csv \
        --out reports/seo/url_diff.json
    cwd: "{{ inputs.astro_project_path }}"
    success_criteria:
      - No missing mappings detected
  - id: compile_seo_report
    name: Compile post-launch SEO report
    run: |
      mkdir -p reports/seo
      bun run scripts/generate-seo-report.mjs \
        --meta reports/seo/meta_audit.json \
        --links reports/seo/internal_links.json \
        --redirects {{ inputs.redirect_manifest }} \
        --out reports/seo/post_launch.md
    cwd: "{{ inputs.astro_project_path }}"
    success_criteria:
      - post_launch.md summarizes issues and passes QC
success_criteria:
  - Sitemap and robots validated
  - Canonicals and internal links free of errors
outputs_mapping:
  seo_report: "{{ inputs.astro_project_path }}/reports/seo/post_launch.md"
  sitemap: "{{ inputs.astro_project_path }}/public/sitemap.xml"
  robots: "{{ inputs.astro_project_path }}/public/robots.txt"
