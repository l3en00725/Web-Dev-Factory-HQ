---
import Container from './Container.astro';
import Logo from '../ui/Logo.astro';
import Button from '../ui/button.astro';
import servicesData from '../../content/services.json';
import settings from '../../content/settings.json';

interface Props {
  navItems?: { title: string; href: string; active?: boolean }[];
  variant?: 'transparent' | 'solid';
  headerMode?: 'light' | 'dark';
}

const { 
  navItems = [],
  variant = 'transparent',
  headerMode = 'dark'  // Default to dark mode (navy text) for bright hero images
} = Astro.props;

// Filter primary services for the dropdown
const primaryServices = servicesData.filter(s => s.type === 'primary');

// Phone number for click-to-call
const phoneNumber = settings.contact.phone;
const phoneLink = `tel:${phoneNumber.replace(/\s/g, '')}`;
---

<header 
  id="site-header"
  class:list={[
    "group fixed top-0 z-50 w-full transition-all duration-300 border-b",
    variant === 'transparent' 
      ? `bg-transparent border-transparent ${headerMode === 'dark' ? 'text-brand-navy' : 'text-white'}` 
      : "bg-white/90 backdrop-blur-md border-slate-200/50 text-brand-navy shadow-sm"
  ]}
  data-variant={variant}
  data-mode={headerMode}
  data-scrolled="false"
>
  <Container class="flex h-20 items-center justify-between">
    <div class="flex-shrink-0">
      <Logo 
        class:list={[
          "transition-all duration-300",
          // Default Desktop
          "w-[160px]",
          // Scrolled State (smaller)
          "group-data-[scrolled=true]:w-[140px]"
        ]} 
      />
    </div>

    {/* Desktop Nav */}
    <nav class="hidden items-center gap-1 md:flex ml-auto">
      {navItems.map((item) => {
        const isServices = item.title === 'Services';
        
        return isServices ? (
          <div class="relative group/dropdown px-2">
            <button 
              class:list={[
                "flex items-center gap-1 px-4 py-2 text-sm font-medium transition-all duration-300 rounded-full cursor-pointer",
                variant === 'transparent' 
                  ? (headerMode === 'dark' 
                      ? "text-brand-navy/90 hover:text-brand-navy hover:bg-slate-100/10"
                      : "text-white/90 hover:text-white hover:bg-white/10")
                  : "text-slate-600 hover:text-primary-600 hover:bg-slate-50",
                 // Scrolled override
                 "group-data-[scrolled=true]:text-slate-600 group-data-[scrolled=true]:hover:text-primary-600 group-data-[scrolled=true]:hover:bg-slate-100"
              ]}
            >
              {item.title}
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-200 group-hover/dropdown:rotate-180"><path d="m6 9 6 6 6-6"/></svg>
            </button>
            
            {/* Dropdown Menu */}
            <div class="absolute left-0 top-full pt-2 opacity-0 translate-y-2 invisible transition-all duration-200 group-hover/dropdown:opacity-100 group-hover/dropdown:translate-y-0 group-hover/dropdown:visible w-64">
              <div class="bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden p-2">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider px-3 py-2 mb-1">Primary Services</div>
                {primaryServices.map(service => (
                  <a 
                    href={`/services/${service.slug}`} 
                    class="block px-3 py-2 text-sm text-slate-700 hover:text-primary-600 hover:bg-slate-50 rounded-lg transition-colors"
                  >
                    {service.title}
                  </a>
                ))}
                <div class="h-px bg-slate-100 my-2"></div>
                <a href="/services" class="block px-3 py-2 text-sm font-medium text-primary-600 hover:text-primary-700 hover:bg-primary-50 rounded-lg transition-colors text-center">
                  View All Services
                </a>
              </div>
            </div>
          </div>
        ) : (
          <a 
            href={item.href} 
            class:list={[
              "relative px-4 py-2 text-sm font-medium transition-all duration-300 rounded-full",
              // Base state (Transparent Header)
              variant === 'transparent' 
                ? (headerMode === 'dark'
                    ? (item.active 
                        ? "text-brand-navy bg-slate-100/20 font-semibold shadow-sm ring-1 ring-slate-300/30" 
                        : "text-brand-navy/90 hover:text-brand-navy hover:bg-slate-100/10")
                    : (item.active 
                        ? "text-white bg-white/20 font-semibold shadow-sm ring-1 ring-white/30" 
                        : "text-white/90 hover:text-white hover:bg-white/10"))
                : (item.active 
                    ? "text-primary-700 bg-primary-50 font-semibold" 
                    : "text-slate-600 hover:text-primary-600 hover:bg-slate-50"),
              
              // Scrolled State Overrides
              item.active && "group-data-[scrolled=true]:bg-primary-50 group-data-[scrolled=true]:text-primary-700 group-data-[scrolled=true]:ring-primary-100 group-data-[scrolled=true]:shadow-none",
              !item.active && "group-data-[scrolled=true]:text-slate-600 group-data-[scrolled=true]:hover:text-primary-600 group-data-[scrolled=true]:hover:bg-slate-100"
            ]}
          >
            {item.title}
          </a>
        );
      })}
      
      <div 
        class:list={[
          "ml-4 pl-4 border-l transition-colors duration-300 flex items-center gap-3",
          variant === 'transparent' 
            ? (headerMode === 'dark' 
                ? "border-slate-300/30 group-data-[scrolled=true]:border-slate-200" 
                : "border-white/20 group-data-[scrolled=true]:border-slate-200")
            : "border-slate-200"
        ]}
      >
        <Button 
          href="/contact" 
          size="md" 
          variant="primary" 
          class="shadow-lg shadow-primary-900/20 border-none bg-secondary-500 hover:bg-secondary-600 text-white"
        >
          Get a Free Quote
        </Button>
        
        {/* Phone Icon Button */}
        <a 
          href={phoneLink}
          aria-label={`Call us at ${phoneNumber}`}
          class="flex items-center justify-center h-10 w-12 rounded-lg transition-all duration-300 shadow-lg shadow-secondary-900/20 bg-secondary-500 hover:bg-secondary-600 text-white hover:scale-105"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
          </svg>
        </a>
      </div>
    </nav>

    {/* Mobile Toggle */}
    <div class="md:hidden">
      <Button 
        variant="ghost" 
        size="sm" 
        id="open-menu" 
        aria-label="Open Menu" 
        class:list={[
          "text-inherit transition-colors",
          variant === 'transparent' && headerMode === 'dark' 
            ? "hover:bg-slate-100/10 group-data-[scrolled=true]:hover:bg-slate-100 group-data-[scrolled=true]:text-slate-700"
            : "hover:bg-white/10 group-data-[scrolled=true]:hover:bg-slate-100 group-data-[scrolled=true]:text-slate-700"
        ]}
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
      </Button>
    </div>
  </Container>
</header>

<script>
  const header = document.getElementById('site-header');
  const openBtn = document.getElementById('open-menu');
  
  // Get initial variant and mode
  const initialVariant = header?.getAttribute('data-variant') || 'transparent';
  const headerMode = header?.getAttribute('data-mode') || 'light';

  // Handle Scroll State
  function updateHeaderState() {
    if (!header || initialVariant === 'solid') return; // Don't change state if forced solid
    
    const isScrolled = window.scrollY > 20;
    
    if (isScrolled) {
      // Scrolled State (Solid/Glass)
      header.classList.remove('bg-transparent', 'border-transparent', 'text-white', 'text-brand-navy');
      header.classList.add('bg-white/90', 'backdrop-blur-md', 'border-slate-200/50', 'text-brand-navy', 'shadow-sm');
    } else {
      // Top State (Transparent) - respect headerMode
      header.classList.add('bg-transparent', 'border-transparent');
      header.classList.remove('bg-white/90', 'backdrop-blur-md', 'border-slate-200/50', 'shadow-sm');
      
      if (headerMode === 'dark') {
        header.classList.add('text-brand-navy');
        header.classList.remove('text-white');
      } else {
        header.classList.add('text-white');
        header.classList.remove('text-brand-navy');
      }
    }
    
    header.setAttribute('data-scrolled', isScrolled.toString());
  }

  if (initialVariant === 'transparent') {
    window.addEventListener('scroll', updateHeaderState, { passive: true });
    // Initial check
    updateHeaderState();
  }

  // Mobile Menu Toggle
  openBtn?.addEventListener('click', () => {
    document.dispatchEvent(new CustomEvent('toggle-menu'));
  });
</script>
