---
import Base from '../../layouts/Base.astro';
import Container from '../../components/layout/Container.astro';

// Check for error parameters from Supabase (expired link, etc.)
const urlParams = Astro.url.searchParams;
const errorCode = urlParams.get('error_code');
const errorDescription = urlParams.get('error_description');
const hasError = urlParams.get('error') === 'access_denied';
const isExpired = errorCode === 'otp_expired';
---

<Base 
  title="Reset Password - Blue Lawns Admin" 
  description="Set your new password"
  noIndex={true}
  headerVariant="solid"
>
  <section class="min-h-[calc(100vh-200px)] flex items-center justify-center bg-gray-50">
    <Container>
      <div class="max-w-md w-full mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-8">
          <h1 class="text-3xl font-bold text-brand-navy mb-2">Set New Password</h1>
          <p class="text-gray-600 mb-6">Enter your new password below</p>
          
          {isExpired && (
            <div class="text-red-600 text-sm bg-red-50 p-3 rounded mb-4">
              <p class="font-semibold mb-1">Password reset link has expired</p>
              <p class="text-sm">The link in your email is only valid for a limited time. Please request a new password reset link.</p>
              <a href="/admin/forgot-password" class="text-primary-500 hover:text-primary-600 underline mt-2 inline-block">
                Request a new reset link →
              </a>
            </div>
          )}
          
          {hasError && !isExpired && (
            <div class="text-red-600 text-sm bg-red-50 p-3 rounded mb-4">
              <p class="font-semibold mb-1">Invalid reset link</p>
              <p class="text-sm">{errorDescription || 'The password reset link is invalid. Please request a new one.'}</p>
              <a href="/admin/forgot-password" class="text-primary-500 hover:text-primary-600 underline mt-2 inline-block">
                Request a new reset link →
              </a>
            </div>
          )}
          
          <div id="token-error" class="hidden text-red-600 text-sm bg-red-50 p-3 rounded mb-4">
            Invalid or missing reset token. Please request a new password reset link.
            <a href="/admin/forgot-password" class="text-primary-500 hover:text-primary-600 underline mt-2 inline-block">
              Request a new reset link →
            </a>
          </div>
          
          <form id="reset-password-form" class="space-y-4">
            <div>
              <label for="password" class="block text-sm font-medium text-gray-700 mb-1">
                New Password
              </label>
              <input
                type="password"
                id="password"
                name="password"
                required
                minlength="8"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                placeholder="At least 8 characters"
              />
            </div>
            
            <div>
              <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">
                Confirm Password
              </label>
              <input
                type="password"
                id="confirm-password"
                name="confirm-password"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                placeholder="Re-enter your password"
              />
            </div>
            
            <div id="error-message" class="hidden text-red-600 text-sm bg-red-50 p-3 rounded"></div>
            <div id="success-message" class="hidden text-green-600 text-sm bg-green-50 p-3 rounded"></div>
            
            <button
              type="submit"
              id="submit-btn"
              class="w-full bg-secondary-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-secondary-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Reset Password
            </button>
            
            <div class="text-center mt-4">
              <a href="/admin/login" class="text-sm text-primary-500 hover:text-primary-600">
                ← Back to Login
              </a>
            </div>
          </form>
        </div>
      </div>
    </Container>
  </section>
</Base>

<script>
  let hasValidSession = false;
  let supabaseClient: any = null;
  
  // Check if there are error parameters in the URL (expired link, etc.)
  const urlParams = new URLSearchParams(window.location.search);
  const hashParams = new URLSearchParams(window.location.hash.substring(1));
  const hasUrlError = urlParams.get('error') === 'access_denied' || hashParams.get('error') === 'access_denied';
  
  // If there's an error, disable the form (error message is shown in Astro template)
  if (hasUrlError) {
    document.getElementById('submit-btn')?.setAttribute('disabled', 'true');
  }
  
  // Initialize Supabase client
  async function initSupabase() {
    // Skip initialization if there's an error in the URL
    if (hasUrlError) {
      return;
    }
    try {
      // Fetch config from API endpoint
      const configRes = await fetch('/api/admin/auth-config');
      if (!configRes.ok) {
        throw new Error('Failed to load auth config');
      }
      const config = await configRes.json();
      
      // Load Supabase from CDN
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
      
      // Create client with auto-refresh enabled and proper storage
      supabaseClient = createClient(config.url, config.key, {
        auth: {
          autoRefreshToken: true,
          persistSession: true,
          detectSessionInUrl: true, // This is key - detects hash fragments automatically
          storage: window.localStorage,
        }
      });
      
      // Check URL hash first - Supabase redirects with #access_token=...&type=recovery
      const hash = window.location.hash;
      const hasRecoveryToken = hash.includes('access_token') && !hash.includes('error');
      
      if (hasRecoveryToken) {
        // Supabase should automatically process the hash, but let's wait for it
        // The getSession call will trigger processing of the hash fragment
        setTimeout(async () => {
          const { data: { session }, error } = await supabaseClient.auth.getSession();
          
          if (session && !error) {
            hasValidSession = true;
            document.getElementById('token-error')?.classList.add('hidden');
            document.getElementById('submit-btn')?.removeAttribute('disabled');
            // Clean up the hash from URL for security
            window.history.replaceState(null, '', window.location.pathname + window.location.search);
          } else {
            console.error('Session error:', error);
            document.getElementById('token-error')?.classList.remove('hidden');
            document.getElementById('submit-btn')?.setAttribute('disabled', 'true');
          }
        }, 300);
      } else {
        // No hash token - check if there's already a valid session
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        
        if (session && !error) {
          hasValidSession = true;
          document.getElementById('token-error')?.classList.add('hidden');
          document.getElementById('submit-btn')?.removeAttribute('disabled');
        } else {
          // Listen for auth state changes
          supabaseClient.auth.onAuthStateChange((event: string, session: any) => {
            console.log('Auth state changed:', event, session ? 'has session' : 'no session');
            if (event === 'PASSWORD_RECOVERY' || (event === 'SIGNED_IN' && session)) {
              hasValidSession = true;
              document.getElementById('token-error')?.classList.add('hidden');
              document.getElementById('submit-btn')?.removeAttribute('disabled');
            }
          });
          
          // No token in URL and no session - show error
          document.getElementById('token-error')?.classList.remove('hidden');
          document.getElementById('submit-btn')?.setAttribute('disabled', 'true');
        }
      }
    } catch (error) {
      console.error('Failed to initialize Supabase:', error);
      document.getElementById('token-error')?.classList.remove('hidden');
      document.getElementById('submit-btn')?.setAttribute('disabled', 'true');
    }
  }
  
  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSupabase);
  } else {
    initSupabase();
  }
  
  document.getElementById('reset-password-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!hasValidSession) {
      const errorEl = document.getElementById('error-message')!;
      errorEl.textContent = 'Please click the link from your email to reset your password.';
      errorEl.classList.remove('hidden');
      return;
    }
    
    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const password = formData.get('password') as string;
    const confirmPassword = formData.get('confirm-password') as string;
    
    if (password !== confirmPassword) {
      const errorEl = document.getElementById('error-message')!;
      errorEl.textContent = 'Passwords do not match';
      errorEl.classList.remove('hidden');
      return;
    }
    
    if (password.length < 8) {
      const errorEl = document.getElementById('error-message')!;
      errorEl.textContent = 'Password must be at least 8 characters';
      errorEl.classList.remove('hidden');
      return;
    }
    
    const errorEl = document.getElementById('error-message')!;
    const successEl = document.getElementById('success-message')!;
    errorEl.classList.add('hidden');
    successEl.classList.add('hidden');
    
    const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    submitButton.disabled = true;
    submitButton.textContent = 'Resetting...';
    
    try {
      const response = await fetch('/api/admin/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password }),
      });
      
      const data = await response.json();
      
      if (response.ok) {
        successEl.textContent = 'Password reset successfully! Redirecting to login...';
        successEl.classList.remove('hidden');
        setTimeout(() => {
          window.location.href = '/admin/login?success=password_reset';
        }, 2000);
      } else {
        errorEl.textContent = data.error || 'Failed to reset password. The link may have expired.';
        errorEl.classList.remove('hidden');
        submitButton.disabled = false;
        submitButton.textContent = 'Reset Password';
      }
    } catch (error) {
      errorEl.textContent = 'An error occurred. Please try again.';
      errorEl.classList.remove('hidden');
      submitButton.disabled = false;
      submitButton.textContent = 'Reset Password';
    }
  });
</script>

