---
import '../styles/tokens.css';
import '../styles/design-system.css';
// Fonts with font-display: swap for better performance
import '@fontsource/dm-sans/400.css';
import '@fontsource/dm-sans/700.css';
import '@fontsource/outfit/700.css';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import MobileMenu from '../components/layout/MobileMenu.astro';
import { buildCanonicalUrl } from '../lib/seo-utils';
import { validateSchemaObject } from '../lib/schema-validator';
import settings from '../content/settings.json';
import navigation from '../content/navigation.json';

interface Props {
  title: string;
  description?: string;
  structuredData?: Record<string, unknown>;
  canonicalUrl?: string;
  noIndex?: boolean;
  noFollow?: boolean;
  heroImage?: string;
  ogImage?: string;
  headerVariant?: 'transparent' | 'solid';
  headerMode?: 'light' | 'dark';
}

const { 
  title, 
  description, 
  structuredData, 
  canonicalUrl, 
  noIndex, 
  noFollow,
  heroImage,
  ogImage,
  headerVariant = 'transparent',
  headerMode = 'dark'  // Default to dark (navy text) since most heroes are bright
} = Astro.props;

const siteUrl = settings.siteUrl || Astro.url.origin;
const canonical = buildCanonicalUrl(Astro.url.pathname, siteUrl, canonicalUrl);

// Static logo and site title
const logoSrc = settings.logo;
const siteTitle = settings.title;

// OG Image Logic - Use dynamic Vercel OG API
// Convert asset paths to public paths for OG images
function convertToPublicPath(imagePath: string | undefined): string {
  if (!imagePath) return "/opengraph.jpg";
  
  // If already a public path (starts with /), use as-is
  if (imagePath.startsWith('/')) return imagePath;
  
  // If it's an absolute URL, use as-is
  if (imagePath.startsWith('http')) return imagePath;
  
  // Convert asset paths like "src/assets/images/..." to public paths
  // For service images: "src/assets/images/services/landscaping/hero-manual.webp" 
  // -> try "/images/services/landscaping/hero-manual.webp" or fallback
  if (imagePath.startsWith('src/assets/images/')) {
    const publicPath = imagePath.replace('src/assets/images/', '/images/');
    return publicPath;
  }
  
  // Default fallback
  return "/opengraph.jpg";
}

// Determine which image to use: ogImage > heroImage > fallback
const selectedImage = ogImage || heroImage || "/opengraph.jpg";
const publicImagePath = convertToPublicPath(selectedImage);

const currentOrigin = Astro.url.origin;
const encodedTitle = encodeURIComponent(title);
const encodedImage = encodeURIComponent(publicImagePath);
const ogUrl = `${currentOrigin}/api/og?title=${encodedTitle}&image=${encodedImage}`;

// Validate and clean structured data
const cleanedStructuredData = structuredData ? validateSchemaObject(structuredData) : null;

// Map nav items to Header format
const mappedNavItems = navigation.map((item) => ({
  title: item.label,
  href: item.href,
  active: Astro.url.pathname === item.href,
}));
---

<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    {description && <meta name="description" content={description} />}
    
    {/* Resource hints - preconnect to external domains */}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    {import.meta.env.PUBLIC_GOOGLE_PLACES_API_KEY && (
      <>
        <link rel="preconnect" href="https://maps.googleapis.com" />
        <link rel="dns-prefetch" href="https://maps.googleapis.com" />
      </>
    )}
    {settings.analytics?.googleAnalyticsId && (
      <>
        <link rel="preconnect" href="https://www.googletagmanager.com" />
        <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
      </>
    )}
    
    {/* Preload hero image for LCP optimization */}
    <link 
      rel="preload" 
      as="image" 
      href="/_astro/hero-main.D0OZzk_t.avif"
      type="image/avif"
      fetchpriority="high"
    />
    <link 
      rel="preload" 
      as="image" 
      href="/_astro/hero-main-optimized.nuOsPrLl.webp"
      type="image/webp"
      fetchpriority="high"
    />
    
    {/* Default robots meta - allow indexing unless explicitly disabled */}
    {noIndex && noFollow ? (
      <meta name="robots" content="noindex, nofollow" />
    ) : noIndex ? (
      <meta name="robots" content="noindex" />
    ) : noFollow ? (
      <meta name="robots" content="nofollow" />
    ) : (
      <meta name="robots" content="index, follow" />
    )}
    <link rel="canonical" href={canonical} />
    <title>{title}</title>

    {/* Open Graph / Facebook */}
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={title} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:image" content={ogUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <link rel="icon" type="image/png" sizes="32x32" href="/logo/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/logo/favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/logo/favicon-180.png">
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonical} />
    <meta property="twitter:title" content={title} />
    {description && <meta property="twitter:description" content={description} />}
    <meta name="twitter:image" content={ogUrl} />
    
    {cleanedStructuredData && (
      <script type="application/ld+json" set:html={JSON.stringify(cleanedStructuredData)} />
    )}
    
    {/* Google Analytics GA4 */}
    {settings.analytics?.googleAnalyticsId && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${settings.analytics.googleAnalyticsId}`}></script>
        <script is:inline define:vars={{ gaId: settings.analytics.googleAnalyticsId }}>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', gaId, {
            'send_page_view': false // We'll handle this with our custom tracker
          });
        </script>
      </>
    )}
    
    {/* Custom Analytics Event Tracker - Deferred for better TBT */}
    <script defer src="/js/analytics.js"></script>
  </head>
  <body class="flex min-h-screen flex-col bg-gray-50 text-brand-navy font-sans antialiased">
    <!-- Skip to main content link for keyboard/screen reader users -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[200] focus:bg-white focus:text-brand-navy focus:px-4 focus:py-2 focus:rounded-lg focus:shadow-lg focus:font-medium">
      Skip to main content
    </a>
    
    <Header 
      navItems={mappedNavItems} 
      variant={headerVariant}
      headerMode={headerMode}
    />
    
    <MobileMenu items={mappedNavItems} />

    <main id="main-content" class="flex-1">
      <slot />
    </main>

    <Footer />
  </body>
</html>
