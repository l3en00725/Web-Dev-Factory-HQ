---
import '../styles/tokens.css';
import '../styles/design-system.css';
import '@fontsource/dm-sans/400.css';
import '@fontsource/dm-sans/500.css';
import '@fontsource/dm-sans/700.css';
import '@fontsource/outfit/400.css';
import '@fontsource/outfit/500.css';
import '@fontsource/outfit/700.css';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import MobileMenu from '../components/layout/MobileMenu.astro';
import { buildCanonicalUrl } from '../lib/seo-utils';
import { validateSchemaObject } from '../lib/schema-validator';
import settings from '../content/settings.json';
import navigation from '../content/navigation.json';

interface Props {
  title: string;
  description?: string;
  structuredData?: Record<string, unknown>;
  canonicalUrl?: string;
  noIndex?: boolean;
  noFollow?: boolean;
  ogImage?: string;
  headerVariant?: 'transparent' | 'solid';
  headerMode?: 'light' | 'dark';
}

const { 
  title, 
  description, 
  structuredData, 
  canonicalUrl, 
  noIndex, 
  noFollow, 
  ogImage: pageOgImage,
  headerVariant = 'transparent',
  headerMode = 'dark'  // Default to dark (navy text) since most heroes are bright
} = Astro.props;

const siteUrl = settings.siteUrl || Astro.url.origin;
const canonical = buildCanonicalUrl(Astro.url.pathname, siteUrl, canonicalUrl);

// Static logo and site title
const logoSrc = settings.logo;
const siteTitle = settings.title;

// OG Image Logic - Use static fallback or page-provided image
// The /api/og dynamic generator can be used but falls back to static for reliability
const currentOrigin = Astro.url.origin;
const resolvedOgImage = pageOgImage 
  ? (pageOgImage.startsWith('http') ? pageOgImage : `${currentOrigin}${pageOgImage}`)
  : `${currentOrigin}/opengraph.jpg`;

// Validate and clean structured data
const cleanedStructuredData = structuredData ? validateSchemaObject(structuredData) : null;

// Map nav items to Header format
const mappedNavItems = navigation.map((item) => ({
  title: item.label,
  href: item.href,
  active: Astro.url.pathname === item.href,
}));
---

<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    {description && <meta name="description" content={description} />}
    
    {/* Default robots meta - allow indexing unless explicitly disabled */}
    {noIndex && noFollow ? (
      <meta name="robots" content="noindex, nofollow" />
    ) : noIndex ? (
      <meta name="robots" content="noindex" />
    ) : noFollow ? (
      <meta name="robots" content="nofollow" />
    ) : (
      <meta name="robots" content="index, follow" />
    )}
    <link rel="canonical" href={canonical} />
    <title>{title}</title>

    {/* Open Graph / Facebook */}
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={title} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:image" content={resolvedOgImage} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:type" content="image/jpeg" />

    <link rel="icon" type="image/png" sizes="32x32" href="/logo/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/logo/favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/logo/favicon-180.png">
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonical} />
    <meta property="twitter:title" content={title} />
    {description && <meta property="twitter:description" content={description} />}
    <meta property="twitter:image" content={resolvedOgImage} />
    
    {cleanedStructuredData && (
      <script type="application/ld+json" set:html={JSON.stringify(cleanedStructuredData)} />
    )}
    
    {/* Google Analytics GA4 */}
    {settings.analytics?.googleAnalyticsId && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${settings.analytics.googleAnalyticsId}`}></script>
        <script is:inline define:vars={{ gaId: settings.analytics.googleAnalyticsId }}>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', gaId, {
            'send_page_view': false // We'll handle this with our custom tracker
          });
        </script>
      </>
    )}
    
    {/* Custom Analytics Event Tracker */}
    <script is:inline src="/js/analytics.js"></script>
    
    {/* Google Places API (New) for Address Autocomplete */}
    {import.meta.env.PUBLIC_GOOGLE_PLACES_API_KEY && (
      <script 
        src={`https://maps.googleapis.com/maps/api/js?key=${import.meta.env.PUBLIC_GOOGLE_PLACES_API_KEY}&libraries=places&loading=async`}
        async
        defer
      ></script>
    )}
  </head>
  <body class="flex min-h-screen flex-col bg-gray-50 text-brand-navy font-sans antialiased">
    <!-- Skip to main content link for keyboard/screen reader users -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[200] focus:bg-white focus:text-brand-navy focus:px-4 focus:py-2 focus:rounded-lg focus:shadow-lg focus:font-medium">
      Skip to main content
    </a>
    
    <Header 
      navItems={mappedNavItems} 
      variant={headerVariant}
      headerMode={headerMode}
    />
    
    <MobileMenu items={mappedNavItems} />

    <main id="main-content" class="flex-1">
      <slot />
    </main>

    <Footer />
  </body>
</html>
